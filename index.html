<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–õ–ê–ù–ï–† 21</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, arrayUnion, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFPgvkN6yAxcJqbUak-bh5akmL5oiPSCs",
            authDomain: "planner21-47147.firebaseapp.com",
            projectId: "planner21-47147",
            storageBucket: "planner21-47147.firebasestorage.app",
            messagingSenderId: "678376272314",
            appId: "1:678376272314:web:4519c23ede2462f6d7ad83",
            measurementId: "G-2RRNNW5YZY"
        };

        const tg = window.Telegram.WebApp;
        tg.expand();

        let db, auth;
        let user = tg.initDataUnsafe.user || { first_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", id: 492384348 };
        let currentRoomId = String(user.id);
        let tasks = [];
        let unsubscribe = null;
        let isAdmin = false;
        let clickCount = 0;
        let clickTimer = null;

        const categories = [
            { id: 'work', icon: 'üíº', label: '–†–∞–±–æ—Ç–∞' },
            { id: 'home', icon: 'üè†', label: '–î–æ–º' },
            { id: 'sport', icon: 'üí™', label: '–°–ø–æ—Ä—Ç' },
            { id: 'shop', icon: 'üõí', label: '–ú–∞–≥–∞–∑–∏–Ω' },
            { id: 'other', icon: 'üåä', label: '–í–∞–π–±' }
        ];

        async function init() {
            document.getElementById('task-date').valueAsDate = new Date();
            renderCategories();
            updateRoomUI();

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (fbUser) => {
                    if (fbUser) {
                        updateStatus('–í —Å–µ—Ç–∏', 'text-emerald-400');
                        startListening();
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (err) {
                updateStatus('–û—Ñ—Ñ–ª–∞–π–Ω', 'text-rose-400');
            }
        }

        // –°–µ–∫—Ä–µ—Ç–Ω—ã–π –≤—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É
        window.handleLogoClick = () => {
            clickCount++;
            clearTimeout(clickTimer);
            clickTimer = setTimeout(() => clickCount = 0, 2000);

            if (clickCount >= 5) {
                clickCount = 0;
                const pass = prompt("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
                if (pass === "0000") { // –í–ê–® –ü–ê–†–û–õ–¨ –¢–£–¢
                    isAdmin = true;
                    document.getElementById('admin-badge').classList.remove('hidden');
                    tg.HapticFeedback.notificationOccurred('success');
                    alert("–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
                }
            }
        };

        function updateStatus(text, colorClass) {
            const el = document.getElementById('user-status');
            el.innerText = text;
            el.className = `text-[10px] font-bold uppercase tracking-widest ${colorClass}`;
        }

        function updateRoomUI() {
            const isPrivate = currentRoomId === String(user.id);
            const roomBadge = document.getElementById('room-id-display');
            roomBadge.innerText = isPrivate ? '–õ–∏—á–Ω–æ–µ' : `–ì—Ä—É–ø–ø–∞: ${currentRoomId}`;
            roomBadge.className = `text-[9px] font-black px-2 py-0.5 rounded-full ${isPrivate ? 'bg-slate-100 text-slate-400' : 'bg-indigo-100 text-indigo-600'}`;
        }

        function renderCategories() {
            const container = document.getElementById('category-select');
            container.innerHTML = categories.map(cat => `
                <button onclick="selectCategory('${cat.id}')" id="cat-${cat.id}" 
                        class="flex-shrink-0 w-12 h-12 rounded-2xl transition-all flex items-center justify-center text-xl grayscale hover:grayscale-0 active:scale-90 bg-slate-50 dark:bg-slate-800/40">
                    ${cat.icon}
                </button>
            `).join('');
            selectCategory('other');
        }

        let selectedCat = 'other';
        window.selectCategory = (id) => {
            categories.forEach(c => {
                const btn = document.getElementById(`cat-${c.id}`);
                if(btn) {
                    btn.classList.add('grayscale');
                    btn.classList.remove('bg-indigo-500', 'shadow-vibe-intense');
                }
            });
            const activeBtn = document.getElementById(`cat-${id}`);
            if(activeBtn) {
                activeBtn.classList.remove('grayscale');
                activeBtn.classList.add('bg-indigo-500', 'shadow-vibe-intense');
            }
            selectedCat = id;
        };

        function startListening() {
            if (unsubscribe) unsubscribe();
            const appId = 'planner21-prod';
            const collectionPath = collection(db, 'artifacts', appId, 'users', currentRoomId, 'tasks');

            unsubscribe = onSnapshot(collectionPath, (snap) => {
                tasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });
        }

        window.addTask = async () => {
            const input = document.getElementById('task-input');
            const time = document.getElementById('task-time').value;
            const date = document.getElementById('task-date').value;
            const priority = document.getElementById('task-priority').value;
            const isDaily = document.getElementById('is-daily').checked;
            const text = input.value.trim();

            if (!text) return tg.HapticFeedback.notificationOccurred('error');

            const payload = {
                text, time, date, priority, isDaily,
                category: selectedCat,
                done: false,
                subtasks: [],
                createdAt: Date.now(),
                author: user.first_name
            };

            const appId = 'planner21-prod';
            await addDoc(collection(db, 'artifacts', appId, 'users', currentRoomId, 'tasks'), payload);
            input.value = '';
            tg.HapticFeedback.impactOccurred('medium');
        };

        window.toggleTask = async (id, currentStatus) => {
            const appId = 'planner21-prod';
            const ref = doc(db, 'artifacts', appId, 'users', currentRoomId, 'tasks', id);
            await updateDoc(ref, { done: !currentStatus });
            if (!currentStatus) confetti({ particleCount: 30, origin: { y: 0.8 } });
        };

        window.switchRoom = () => {
            const newId = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:", currentRoomId === String(user.id) ? "" : currentRoomId);
            const finalId = (newId && newId.trim() !== "") ? newId.trim() : String(user.id);
            if (finalId !== currentRoomId) {
                currentRoomId = finalId;
                updateRoomUI();
                startListening();
            }
        };

        window.hTS = (e) => touchStartX = e.touches[0].clientX;
        let touchStartX = 0;
        window.hTM = (e) => {
            const diff = touchStartX - e.touches[0].clientX;
            if (diff > 20 && diff < 100) e.currentTarget.style.transform = `translateX(-${diff}px)`;
        };
        window.hTE = (e, id) => {
            const diff = touchStartX - e.changedTouches[0].clientX;
            if (diff > 80) {
                tg.showConfirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?", (ok) => {
                    if (ok) {
                        const appId = 'planner21-prod';
                        deleteDoc(doc(db, 'artifacts', appId, 'users', currentRoomId, 'tasks', id));
                    }
                });
            }
            e.currentTarget.style.transform = `translateX(0)`;
        };

        function render() {
            const container = document.getElementById('task-list');
            container.innerHTML = '';
            const doneCount = tasks.filter(t => t.done).length;
            const progress = tasks.length > 0 ? (doneCount/tasks.length)*100 : 0;
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').innerText = `${doneCount} / ${tasks.length}`;

            tasks.sort((a,b) => b.createdAt - a.createdAt).forEach(t => {
                const cat = categories.find(c => c.id === t.category) || categories[4];
                const el = document.createElement('div');
                el.className = 'relative overflow-hidden mb-3 rounded-[1.5rem] bg-rose-500/10 dark:bg-rose-500/5';
                el.innerHTML = `
                    <div class="absolute inset-0 flex items-center justify-end pr-6 text-[9px] font-black text-rose-500 uppercase italic">–£–¥–∞–ª–∏—Ç—å</div>
                    <div ontouchstart="hTS(event)" ontouchmove="hTM(event)" ontouchend="hTE(event, '${t.id}')"
                         class="bg-white dark:bg-slate-900 p-5 flex items-center gap-4 relative transition-all duration-300 border border-slate-100 dark:border-slate-800 shadow-sm">
                        <div onclick="toggleTask('${t.id}', ${t.done})" class="w-6 h-6 rounded-lg border-2 flex-shrink-0 flex items-center justify-center transition-all ${t.done ? 'bg-indigo-500 border-indigo-500 shadow-vibe-intense' : 'border-slate-100 dark:border-slate-700'}">
                            ${t.done ? '<svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path></svg>' : ''}
                        </div>
                        <div class="flex-grow overflow-hidden">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${cat.icon}</span>
                                <p class="text-sm font-bold truncate ${t.done ? 'line-through text-slate-300' : 'text-slate-800 dark:text-slate-100'}">${t.text}</p>
                            </div>
                            <div class="flex flex-wrap gap-2 mt-1.5 text-[8px] font-bold text-slate-400">
                                <span class="uppercase">${t.priority}</span>
                                <span>üìÖ ${t.date}</span>
                                ${currentRoomId !== String(user.id) ? `<span class="italic text-indigo-400">–æ—Ç ${t.author}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
        }
        init();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;800&display=swap');
        body { background: #fafbfc; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        @media (prefers-color-scheme: dark) { body { background: #030712; color: white; } }
        .shadow-vibe-intense { box-shadow: 0 4px 12px -2px rgba(79, 70, 229, 0.3); }
        input, select { -webkit-appearance: none; background: transparent; border: none !important; outline: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-6 pb-24">

    <!-- –®–∞–ø–∫–∞ -->
    <header class="flex items-center justify-between mb-10">
        <div class="flex items-center gap-4 group cursor-pointer">
            <div onclick="handleLogoClick()" class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-vibe-intense rotate-3 transition-all active:scale-90">
                <span class="text-[10px] font-black italic">P21</span>
            </div>
            <div onclick="switchRoom()">
                <h1 class="text-lg font-extrabold tracking-tight text-slate-900 dark:text-white mb-0.5 flex items-center gap-2">
                    ${user.first_name}
                    <span id="admin-badge" class="hidden bg-rose-500 text-white text-[8px] px-1.5 py-0.5 rounded-md uppercase italic">Admin</span>
                </h1>
                <div class="flex items-center gap-2">
                    <p id="user-status" class="text-[9px] font-bold uppercase tracking-widest text-emerald-500">–í —Å–µ—Ç–∏</p>
                    <span id="room-id-display" class="text-[9px] font-black px-2 py-0.5 rounded-full bg-slate-100 text-slate-400">–õ–∏—á–Ω–æ–µ</span>
                </div>
            </div>
        </div>
        <div class="text-right">
            <span id="progress-text" class="text-base font-extrabold italic text-indigo-600 leading-none">0/0</span>
        </div>
    </header>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
    <div class="bg-white dark:bg-slate-900 rounded-[1.5rem] p-4 mb-10 border border-slate-100 dark:border-slate-800 shadow-sm">
        <div class="h-1.5 bg-slate-50 dark:bg-slate-800 rounded-full overflow-hidden">
            <div id="progress-bar" class="h-full bg-indigo-500 rounded-full transition-all duration-700" style="width: 0%"></div>
        </div>
    </div>

    <!-- –í–≤–æ–¥ –∑–∞–¥–∞—á–∏ -->
    <div class="bg-white dark:bg-slate-900 p-2 rounded-[2rem] mb-10 border border-slate-100 dark:border-slate-800 shadow-sm">
        <div class="flex items-center p-1">
            <input type="text" id="task-input" placeholder="–ö–∞–∫–∏–µ –ø–ª–∞–Ω—ã?" class="flex-grow px-5 py-4 font-bold text-sm dark:text-white">
            <button onclick="addTask()" class="bg-indigo-600 text-white p-4 rounded-full shadow-vibe-intense active:scale-90 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="4"></path></svg>
            </button>
        </div>
        <div class="px-4 pb-4">
            <div id="category-select" class="flex gap-2 mb-6 overflow-x-auto no-scrollbar"></div>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <input type="date" id="task-date" class="bg-slate-50 dark:bg-slate-800/40 p-3.5 rounded-xl text-[11px] font-bold dark:text-white">
                <input type="time" id="task-time" class="bg-slate-50 dark:bg-slate-800/40 p-3.5 rounded-xl text-[11px] font-bold dark:text-white">
            </div>
            <div class="flex items-center justify-between">
                <select id="task-priority" class="text-[9px] font-black uppercase text-indigo-500">
                    <option value="–í—ã—Å–æ–∫–∏–π">üî• –í—ã—Å–æ–∫–∏–π</option>
                    <option value="–û–±—ã—á–Ω—ã–π" selected>‚ö° –û–±—ã—á–Ω—ã–π</option>
                    <option value="–ù–∏–∑–∫–∏–π">üçÉ –ù–∏–∑–∫–∏–π</option>
                </select>
                <label class="flex items-center gap-3">
                    <input type="checkbox" id="is-daily" class="sr-only peer">
                    <span class="text-[9px] font-black uppercase text-slate-300 peer-checked:text-indigo-500 transition-colors">–ü–æ–≤—Ç–æ—Ä</span>
                    <div class="w-8 h-4 bg-slate-100 dark:bg-slate-800 rounded-full peer-checked:bg-indigo-600 transition-all relative after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:w-3 after:h-3 after:rounded-full peer-checked:after:translate-x-4 after:transition-all"></div>
                </label>
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ -->
    <div id="task-list" class="space-y-3"></div>

</body>
</html>
