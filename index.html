<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–õ–ê–ù–ï–† 21</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, query, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFPgvkN6yAxcJqbUak-bh5akmL5oiPSCs",
            authDomain: "planner21-47147.firebaseapp.com",
            projectId: "planner21-47147",
            storageBucket: "planner21-47147.firebasestorage.app",
            messagingSenderId: "678376272314",
            appId: "1:678376272314:web:4519c23ede2462f6d7ad83"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'planner21-prod';

        const tg = window.Telegram.WebApp;
        tg.expand();

        const quotes = [
            "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî —ç—Ç–æ –≤—ã–±–æ—Ä –º–µ–∂–¥—É —Ç–µ–º, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–µ–π—á–∞—Å, –∏ —Ç–µ–º, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ.",
            "–¢–≤–æ—ë –±—É–¥—É—â–µ–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–µ–º, —á—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å —Å–µ–≥–æ–¥–Ω—è, –∞ –Ω–µ —Ç–µ–º, —á—Ç–æ —Ç—ã –±—É–¥–µ—à—å –¥–µ–ª–∞—Ç—å –∑–∞–≤—Ç—Ä–∞.",
            "–ü—Ä–æ—Å—Ç–æ—Ç–∞ ‚Äî —ç—Ç–æ –ø—Ä–µ–¥–µ–ª—å–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å –∏—Å–∫—É—à–µ–Ω–Ω–æ—Å—Ç–∏.",
            "–§–æ–∫—É—Å ‚Äî —ç—Ç–æ —É–º–µ–Ω–∏–µ —Å–∫–∞–∑–∞—Ç—å ¬´–Ω–µ—Ç¬ª —Å–æ—Ç–Ω–µ —Ö–æ—Ä–æ—à–∏—Ö –∏–¥–µ–π —Ä–∞–¥–∏ –æ–¥–Ω–æ–π –≤–µ–ª–∏–∫–æ–π.",
            "–í—Ä–µ–º—è ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ—Å—É—Ä—Å, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–ª—å–∑—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å. –¢—Ä–∞—Ç—å –µ–≥–æ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ.",
            "–ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –±–æ–ª—å—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º –≤ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ."
        ];

        const getInitialName = () => {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const tgUser = tg.initDataUnsafe.user;
                return tgUser.first_name || (tgUser.username ? `@${tgUser.username}` : "–ú–æ–π –ü–ª–∞–Ω");
            }
            return "–ú–æ–π –ü–ª–∞–Ω";
        };

        let user = {
            first_name: getInitialName(),
            id: tg.initDataUnsafe.user ? String(tg.initDataUnsafe.user.id) : 'guest_' + Math.random().toString(36).substr(2, 9)
        };

        let currentRoomId = user.id;
        let tasks = [];
        let unsubscribers = [];
        let isAdmin = false;
        let logoClickCount = 0;
        let logoClickTimer = null;

        const categories = [
            { id: 'work', icon: 'üíº', label: '–†–∞–±–æ—Ç–∞' },
            { id: 'home', icon: 'üè†', label: '–î–æ–º' },
            { id: 'sport', icon: 'üí™', label: '–°–ø–æ—Ä—Ç' },
            { id: 'shop', icon: 'üõí', label: '–ú–∞–≥–∞–∑–∏–Ω' },
            { id: 'other', icon: 'üåä', label: '–í–∞–π–±' }
        ];

        async function init() {
            document.getElementById('task-date').valueAsDate = new Date();
            document.getElementById('display-name').innerText = user.first_name;
            document.getElementById('daily-quote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
            
            renderCategories();
            updateRoomUI();

            signInAnonymously(auth).catch(err => console.error("Auth error:", err));

            onAuthStateChanged(auth, (u) => {
                if (u) {
                    startListening();
                }
            });

            document.getElementById('task-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });
        }

        window.handleLogoClick = () => {
            logoClickCount++;
            clearTimeout(logoClickTimer);
            logoClickTimer = setTimeout(() => { logoClickCount = 0; }, 500);

            if (logoClickCount >= 5) {
                logoClickCount = 0;
                if (isAdmin) {
                    const nr = prompt("–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã:");
                    if (nr) { currentRoomId = nr; isAdmin = false; startListening(); updateRoomUI(); }
                    return;
                }
                const pass = prompt("–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞:");
                if (pass === "8055") {
                    isAdmin = true;
                    document.getElementById('admin-badge').classList.remove('hidden');
                    tg.HapticFeedback.notificationOccurred('success');
                    startAdminGlobalListening();
                } else {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            }
        };

        function clearListeners() {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
        }

        function startListening() {
            if (isAdmin) return;
            clearListeners();
            const collectionPath = collection(db, 'artifacts', appId, 'public', 'data', `tasks_${currentRoomId}`);
            const unsub = onSnapshot(collectionPath, (snap) => {
                tasks = snap.docs.map(d => ({ id: d.id, roomId: currentRoomId, ...d.data() }));
                render();
            }, (err) => console.error("Firestore Error:", err));
            unsubscribers.push(unsub);
        }

        function startAdminGlobalListening() {
            clearListeners();
            const globalPath = collection(db, 'artifacts', appId, 'public', 'data', 'all_tasks_registry');
            const unsub = onSnapshot(globalPath, (snap) => {
                tasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }, (err) => console.error("Admin Error:", err));
            unsubscribers.push(unsub);
            document.getElementById('room-id-display').innerText = "–û–ë–ó–û–† –í–°–ï–•";
        }

        window.addTask = async () => {
            const input = document.getElementById('task-input');
            const time = document.getElementById('task-time').value;
            const date = document.getElementById('task-date').value;
            const priority = document.getElementById('task-priority').value;
            const text = input.value.trim();

            if (!text) return;

            const payload = {
                text, time, date, priority,
                category: selectedCat,
                done: false,
                createdAt: Date.now(),
                author: user.first_name,
                userId: user.id,
                roomId: currentRoomId
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `tasks_${currentRoomId}`), payload);
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'all_tasks_registry'), payload);
                
                input.value = '';
                tg.HapticFeedback.impactOccurred('medium');
            } catch (e) {
                console.error("Add Error:", e);
            }
        };

        window.toggleTask = async (id, currentStatus, taskRoomId) => {
            const target = taskRoomId || currentRoomId;
            try {
                const refLocal = doc(db, 'artifacts', appId, 'public', 'data', `tasks_${target}`, id);
                await updateDoc(refLocal, { done: !currentStatus });
                if (!currentStatus) confetti({ particleCount: 30, origin: { y: 0.8 } });
            } catch (e) {
                console.error("Toggle Error:", e);
            }
        };

        window.deleteTask = async (id, taskRoomId) => {
            const target = taskRoomId || currentRoomId;
            tg.showConfirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?", async (ok) => {
                if (ok) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `tasks_${target}`, id));
                }
            });
        };

        function updateRoomUI() {
            if (isAdmin) return;
            const isPrivate = currentRoomId === user.id;
            document.getElementById('room-id-display').innerText = isPrivate ? '–õ–∏—á–Ω–æ–µ' : `ID: ${currentRoomId}`;
        }

        let selectedCat = 'other';
        window.selectCategory = (id) => {
            categories.forEach(c => document.getElementById(`cat-${c.id}`)?.classList.add('grayscale'));
            document.getElementById(`cat-${id}`)?.classList.remove('grayscale');
            selectedCat = id;
        };

        function renderCategories() {
            document.getElementById('category-select').innerHTML = categories.map(cat => `
                <button onclick="selectCategory('${cat.id}')" id="cat-${cat.id}" class="flex-shrink-0 w-12 h-12 rounded-2xl transition-all flex items-center justify-center text-xl grayscale bg-slate-50 dark:bg-slate-800/40">
                    ${cat.icon}
                </button>
            `).join('');
            selectCategory('other');
        }

        function render() {
            const container = document.getElementById('task-list');
            container.innerHTML = '';
            
            const doneCount = tasks.filter(t => t.done).length;
            const progress = tasks.length > 0 ? (doneCount/tasks.length)*100 : 0;
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').innerText = `${doneCount} / ${tasks.length}`;

            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-16 text-center">
                        <div class="w-16 h-16 bg-slate-50 dark:bg-slate-900 rounded-full flex items-center justify-center mb-4 border border-slate-100 dark:border-slate-800">
                             <svg class="w-8 h-8 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                        </div>
                        <p class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">–ü–ª–∞–Ω–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                        <p class="text-[9px] text-slate-300 mt-1">–í—Ä–µ–º—è —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ—é —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å</p>
                    </div>`;
                return;
            }

            tasks.sort((a,b) => b.createdAt - a.createdAt).forEach(t => {
                const cat = categories.find(c => c.id === t.category) || categories[4];
                const el = document.createElement('div');
                el.className = `p-5 rounded-[1.5rem] flex items-center gap-4 border shadow-sm mb-3 transition-all ${t.done ? 'bg-slate-50/50 dark:bg-slate-900/40 border-slate-100 dark:border-slate-800 opacity-70' : 'bg-white dark:bg-slate-900 border-slate-100 dark:border-slate-800'}`;
                el.innerHTML = `
                    <div onclick="toggleTask('${t.id}', ${t.done}, '${t.roomId}')" class="w-6 h-6 rounded-lg border-2 flex-shrink-0 flex items-center justify-center cursor-pointer transition-all ${t.done ? 'bg-indigo-500 border-indigo-500' : 'border-slate-200 dark:border-slate-700'}">
                        ${t.done ? '<svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path></svg>' : ''}
                    </div>
                    <div class="flex-grow overflow-hidden text-left">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${cat.icon}</span>
                            <p class="text-sm font-bold ${t.done ? 'line-through text-slate-400' : 'text-slate-800 dark:text-slate-100'}">${t.text}</p>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-1.5">
                            <span class="text-[8px] font-bold text-slate-400 px-2 py-0.5 bg-slate-50 dark:bg-slate-800/60 rounded-full">${t.date} ${t.time || ''}</span>
                            <span class="text-[8px] font-black ${t.priority === '–í—ã—Å–æ–∫–∏–π' ? 'text-rose-500' : 'text-indigo-400'} uppercase tracking-tight">${t.priority}</span>
                            ${isAdmin ? `
                                <span class="text-[9px] font-black text-white px-2 py-0.5 rounded-full bg-indigo-500 uppercase">üë§ ${t.author || '–ê–Ω–æ–Ω–∏–º'}</span>
                            ` : ''}
                        </div>
                    </div>
                    <button onclick="deleteTask('${t.id}', '${t.roomId}')" class="text-slate-300 hover:text-rose-500 transition-colors p-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </button>
                `;
                container.appendChild(el);
            });
        }
        init();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap');
        body { background: #fafbfc; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; letter-spacing: -0.01em; }
        @media (prefers-color-scheme: dark) { body { background: #030712; color: white; } }
        input[type="text"] { width: 100%; background: transparent; border: none; outline: none; padding: 1.25rem; font-weight: 700; font-size: 16px; }
        input[type="date"], input[type="time"] { background: transparent; border: none; outline: none; font-size: 12px; font-weight: 800; color: inherit; width: 100%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .quote-box {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(147, 51, 234, 0.05) 100%);
            border: 1px solid rgba(79, 70, 229, 0.1);
        }
        @media (prefers-color-scheme: dark) {
            .quote-box {
                background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
                border: 1px solid rgba(255, 255, 255, 0.05);
            }
        }
        .glass-progress {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(79, 70, 229, 0.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        @media (prefers-color-scheme: dark) {
            .glass-progress { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.03); }
        }
    </style>
</head>
<body class="p-6">
    <!-- –®–∞–ø–∫–∞ -->
    <header class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
            <div onclick="handleLogoClick()" class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-xl shadow-indigo-100 dark:shadow-none rotate-3 active:scale-95 transition-transform cursor-pointer">
                <span class="text-[10px] font-black italic">P21</span>
            </div>
            <div class="text-left">
                <h1 id="display-name" class="text-lg font-extrabold tracking-tight mb-0.5 truncate max-w-[150px]">...</h1>
                <div class="flex items-center gap-2">
                    <span id="room-id-display" class="text-[9px] font-black px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-400 uppercase tracking-tighter">–õ–∏—á–Ω–æ–µ</span>
                    <span id="admin-badge" class="hidden text-[8px] bg-rose-500 text-white px-1.5 py-0.5 rounded-md font-bold italic uppercase animate-pulse">Admin Mode</span>
                </div>
            </div>
        </div>
        <div class="text-right">
            <span id="progress-text" class="text-base font-extrabold italic text-indigo-600">0/0</span>
        </div>
    </header>

    <!-- –ë–ª–æ–∫ —Ü–∏—Ç–∞—Ç—ã -->
    <div class="quote-box p-6 rounded-[2rem] mb-4 relative overflow-hidden">
        <div class="absolute top-[-10px] left-[-10px] opacity-10">
            <svg class="w-20 h-20 text-indigo-600" fill="currentColor" viewBox="0 0 24 24"><path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.437.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/></svg>
        </div>
        <p id="daily-quote" class="text-center text-[11px] leading-relaxed font-bold text-slate-600 dark:text-slate-300 italic relative z-10">...</p>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–¥ —Ü–∏—Ç–∞—Ç–æ–π -->
    <div class="glass-progress rounded-[1.5rem] p-4 mb-6">
        <div class="h-2 bg-slate-100/50 dark:bg-slate-800/80 rounded-full overflow-hidden relative">
            <div id="progress-bar" class="h-full bg-gradient-to-r from-indigo-500 via-indigo-400 to-indigo-500 rounded-full transition-all duration-1000 ease-out shadow-[0_0_15px_rgba(79,70,229,0.5)]" style="width: 0%"></div>
        </div>
    </div>

    <!-- –°–æ–∑–¥–∞—Ç–µ–ª—å –ø–ª–∞–Ω–æ–≤ –°–í–ï–†–•–£ -->
    <div class="bg-white dark:bg-slate-900 rounded-[2rem] mb-8 border border-slate-100 dark:border-slate-800 overflow-hidden shadow-sm">
        <div class="flex items-center pr-4">
            <input type="text" id="task-input" placeholder="–û —á–µ–º —Ç—ã –¥—É–º–∞–µ—à—å?" class="dark:text-white">
            <button onclick="addTask()" class="bg-indigo-600 text-white p-3.5 rounded-full active:scale-90 transition-all shadow-lg shadow-indigo-200 dark:shadow-none">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="3" stroke-linecap="round"></path></svg>
            </button>
        </div>
        <div class="px-5 pb-5 pt-0">
            <div id="category-select" class="flex gap-2 mb-4 overflow-x-auto no-scrollbar"></div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-slate-50 dark:bg-slate-800/40 p-3 rounded-2xl">
                    <input type="date" id="task-date" class="dark:text-white">
                </div>
                <div class="bg-slate-50 dark:bg-slate-800/40 p-3 rounded-2xl">
                    <input type="time" id="task-time" class="dark:text-white">
                </div>
            </div>
            <select id="task-priority" class="w-full bg-slate-50 dark:bg-slate-800/40 p-3 rounded-2xl text-[10px] font-black uppercase text-indigo-500 appearance-none text-center border-none focus:ring-0">
                <option value="–í—ã—Å–æ–∫–∏–π">üî• –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                <option value="–û–±—ã—á–Ω—ã–π" selected>‚ö° –û–±—ã—á–Ω—ã–π</option>
                <option value="–ù–∏–∑–∫–∏–π">üçÉ –ù–∏–∑–∫–∏–π</option>
            </select>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø–ª–∞–Ω–æ–≤ –°–ù–ò–ó–£ -->
    <div id="task-list" class="pb-10"></div>
</body>
</html>
