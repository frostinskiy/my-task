<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PLANNER 21</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFPgvkN6yAxcJqbUak-bh5akmL5oiPSCs",
            authDomain: "planner21-47147.firebaseapp.com",
            projectId: "planner21-47147",
            storageBucket: "planner21-47147.firebasestorage.app",
            messagingSenderId: "678376272314",
            appId: "1:678376272314:web:4519c23ede2462f6d7ad83",
            measurementId: "G-2RRNNW5YZY"
        };

        const MY_ADMIN_ID = 492384348;
        const TELEGRAM_TOKEN = '8475177436:AAGqptajS1HqA1Xw-ZINU7EGXIutoAy1igU';
        const appId = 'planner21-prod';

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        let db, auth;
        let user = tg.initDataUnsafe.user || { first_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", id: 492384348 };
        let tasks = [];
        let isAdminMode = false;
        let lastNotified = {}; 
        let unsubscribe = null; // –î–ª—è –æ—Ç–ø–∏—Å–∫–∏ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π

        async function init() {
            const userNameEl = document.getElementById('user-name');
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (fbUser) => {
                    if (fbUser) {
                        userNameEl.innerText = user.first_name;
                        userNameEl.classList.remove('text-indigo-500');
                        userNameEl.classList.add('text-green-600');
                        startListening();
                        checkAdminStatus();
                        startReminderEngine();
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (err) {
                userNameEl.innerText = "–û–®–ò–ë–ö–ê –ë–ê–ó–´";
            }
        }

        function checkAdminStatus() {
            if (user.id === MY_ADMIN_ID) {
                const badge = document.getElementById('admin-badge');
                badge.classList.remove('hidden');
                badge.onclick = toggleAdmin;
                badge.innerText = "PRO";
            }
        }

        function toggleAdmin() {
            isAdminMode = !isAdminMode;
            const badge = document.getElementById('admin-badge');
            badge.innerText = isAdminMode ? "ADMIN VIEW" : "MY TASKS";
            badge.classList.toggle('bg-red-500', isAdminMode);
            badge.classList.toggle('text-white', isAdminMode);
            startListening(); // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –Ω—É–∂–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
            tg.HapticFeedback.impactOccurred('medium');
        }

        function startListening() {
            if (unsubscribe) unsubscribe(); // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏

            const path = isAdminMode 
                ? collection(db, 'artifacts', appId, 'public', 'data', 'all_tasks')
                : collection(db, 'artifacts', appId, 'users', String(user.id), 'tasks');

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
            unsubscribe = onSnapshot(path, (snap) => {
                tasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                render(tasks);
            }, (err) => {
                console.error("Firestore Error:", err);
            });
        }

        function startReminderEngine() {
            setInterval(() => {
                const now = new Date();
                const currentTime = now.getHours() * 60 + now.getMinutes();
                const nowMs = Date.now();
                
                tasks.forEach(task => {
                    if (!task.done && task.time) {
                        const [h, m] = task.time.split(':').map(Number);
                        const taskTimeMinutes = h * 60 + m;

                        const isExactTime = taskTimeMinutes === currentTime;
                        const isOverdue = currentTime > taskTimeMinutes;

                        const lastTime = lastNotified[task.id] || 0;
                        const timeSinceLastNotify = (nowMs - lastTime) / (1000 * 60);

                        if (isExactTime && lastTime === 0) {
                            sendTelegramNotification(task, "–ü—Ä–∏—à–ª–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞—á—É!");
                        } else if (isOverdue && timeSinceLastNotify >= 30) {
                            sendTelegramNotification(task, "–ó–∞–¥–∞—á–∞ –≤—Å–µ –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ –Ω–µ–µ!");
                        }
                    }
                });
            }, 30000); 
        }

        async function sendTelegramNotification(task, message) {
            lastNotified[task.id] = Date.now();
            const text = `üîî *–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:* \n\n"${task.text}"\n\n_${message}_ \nüïí –í—Ä–µ–º—è: ${task.time}`;
            try {
                await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: user.id,
                        text: text,
                        parse_mode: 'Markdown'
                    })
                });
            } catch (e) { console.error("Notification failed", e); }
        }

        window.addTask = async () => {
            const input = document.getElementById('task-input');
            const time = document.getElementById('task-time').value;
            const priority = document.getElementById('task-priority').value;
            const text = input.value.trim();

            if (!text) {
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            const payload = {
                text, time, priority,
                done: false,
                userName: user.first_name,
                userId: user.id,
                createdAt: Date.now()
            };

            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–∏—á–Ω—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é
                await addDoc(collection(db, 'artifacts', appId, 'users', String(user.id), 'tasks'), payload);
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±—â—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é (–¥–ª—è –∞–¥–º–∏–Ω–∞)
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'all_tasks'), payload);
                
                input.value = '';
                tg.HapticFeedback.impactOccurred('light');
            } catch (e) {
                tg.showPopup({ title: "–û—à–∏–±–∫–∞", message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å." });
            }
        };

        window.toggleTask = async (id, status) => {
            if (isAdminMode) return;
            const ref = doc(db, 'artifacts', appId, 'users', String(user.id), 'tasks', id);
            await updateDoc(ref, { done: !status });
            tg.HapticFeedback.selectionChanged();
        };

        window.deleteTask = async (id) => {
            if (isAdminMode) return;
            const ref = doc(db, 'artifacts', appId, 'users', String(user.id), 'tasks', id);
            await deleteDoc(ref);
            tg.HapticFeedback.impactOccurred('light');
        };

        function render(listData) {
            const container = document.getElementById('task-list');
            container.innerHTML = '';
            
            const doneCount = listData.filter(t => t.done).length;
            const total = listData.length;
            const prog = total > 0 ? (doneCount / total) * 100 : 0;
            
            document.getElementById('progress-bar').style.width = prog + '%';
            document.getElementById('progress-text').innerText = `${doneCount} / ${total}`;

            if (total === 0) {
                container.innerHTML = '<div class="text-center py-10 opacity-20 font-bold uppercase text-[10px] tracking-widest">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
            listData.sort((a,b) => b.createdAt - a.createdAt).forEach(t => {
                const el = document.createElement('div');
                el.className = 'bg-white rounded-2xl p-4 flex items-center gap-4 mb-3 shadow-sm border border-slate-50 transition-all active:scale-[0.98]';
                el.innerHTML = `
                    <div onclick="toggleTask('${t.id}', ${t.done})" class="w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-colors ${t.done ? 'bg-indigo-600 border-indigo-600' : 'border-slate-200'}">
                        ${t.done ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                    </div>
                    <div class="flex-grow overflow-hidden" onclick="toggleTask('${t.id}', ${t.done})">
                        <p class="text-sm font-bold truncate ${t.done ? 'line-through text-slate-300' : 'text-slate-800'}">${t.text}</p>
                        <div class="flex gap-2 mt-1 items-center">
                            <span class="text-[9px] font-black uppercase px-1.5 py-0.5 rounded bg-slate-100 text-slate-500">${isAdminMode ? t.userName : t.priority}</span>
                            ${t.time ? `<span class="text-[9px] text-indigo-500 font-bold flex items-center gap-1">üïí ${t.time}</span>` : ''}
                        </div>
                    </div>
                    ${!isAdminMode ? `
                        <button onclick="deleteTask('${t.id}')" class="text-slate-200 hover:text-red-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    ` : ''}
                `;
                container.appendChild(el);
            });
        }
        init();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800&display=swap');
        body { background: #fcfdfe; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-5 pb-24 select-none">
    <header class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg rotate-2">
                <span class="text-xs font-black italic">P21</span>
            </div>
            <div>
                <h1 class="text-xl font-extrabold text-slate-900 tracking-tight leading-none">PLANNER 21</h1>
                <p id="user-name" class="text-[10px] font-bold uppercase tracking-widest mt-1 text-indigo-500">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
        <button id="admin-badge" class="hidden px-4 py-2 bg-white shadow-sm border border-slate-100 text-slate-900 rounded-full text-[10px] font-black uppercase transition-all"></button>
    </header>

    <div class="bg-white rounded-[2.5rem] p-6 mb-8 border border-slate-50 shadow-sm">
        <div class="flex justify-between items-end mb-4">
            <span class="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest">–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–Ω—è</span>
            <span id="progress-text" class="text-sm font-black text-slate-900">0 / 0</span>
        </div>
        <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden">
            <div id="progress-bar" class="h-full bg-indigo-600 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
        </div>
    </div>

    <div class="bg-white p-4 rounded-[2.5rem] border border-slate-50 shadow-sm mb-8">
        <div class="flex items-center gap-2 mb-4">
            <input type="text" id="task-input" placeholder="–ß—Ç–æ –ø–ª–∞–Ω–∏—Ä—É–µ—à—å?" class="bg-slate-50 flex-grow px-6 py-4 rounded-2xl outline-none font-bold text-sm text-slate-700">
            <button id="add-btn" onclick="addTask()" class="bg-indigo-600 text-white p-4 rounded-2xl active:scale-90 transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
            </button>
        </div>
        <div class="flex gap-3">
            <input type="time" id="task-time" class="flex-1 bg-slate-50 px-4 py-3 rounded-2xl text-xs font-bold outline-none text-slate-600">
            <select id="task-priority" class="flex-1 bg-slate-50 px-4 py-3 rounded-2xl text-xs font-bold outline-none text-slate-600">
                <option value="–í—ã—Å–æ–∫–∏–π">üöÄ –°—Ä–æ—á–Ω–æ</option>
                <option value="–û–±—ã—á–Ω—ã–π" selected>‚ö°Ô∏è –û–±—ã—á–Ω—ã–π</option>
                <option value="–ù–∏–∑–∫–∏–π">‚òÅÔ∏è –ù–∏–∑–∫–∏–π</option>
            </select>
        </div>
    </div>

    <div id="task-list" class="space-y-1"></div>
</body>
</html>
