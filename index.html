<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PLANNER 21</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, addDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // –í–ù–ò–ú–ê–ù–ò–ï: –ï—Å–ª–∏ —Ç—ã –∑–∞–ø—É—Å–∫–∞–µ—à—å —ç—Ç–æ –Ω–∞ —Å–≤–æ–µ–º —Ö–æ—Å—Ç–∏–Ω–≥–µ, –∑–∞–º–µ–Ω–∏ –æ–±—ä–µ–∫—Ç –Ω–∏–∂–µ –Ω–∞ —Å–≤–æ–∏ –∫–ª—é—á–∏ –∏–∑ Firebase Console
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(__firebase_config);
        } catch(e) {
            console.warn("–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–ª—é—á–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.");
            // –°—é–¥–∞ –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–∏ –∫–ª—é—á–∏ –≤—Ä—É—á–Ω—É—é:
            // firebaseConfig = { apiKey: "...", ... };
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'todo-mini-app';

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const MY_ADMIN_ID = 492384348;
        const TELEGRAM_TOKEN = '8475177436:AAGqptajS1HqA1Xw-ZINU7EGXIutoAy1igU';
        
        let user = tg.initDataUnsafe.user || { first_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", id: 492384348 }; 
        let tasks = [];
        let allUsersTasks = []; 
        let isAdminView = false;
        let unsubscribeUserTasks = null;
        let unsubscribeAdminTasks = null;

        async function startApp() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (fbUser) => {
                    if (fbUser) {
                        initData();
                        setupAdminUI();
                    } else {
                        document.getElementById('user-name').innerText = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞";
                    }
                });
            } catch (e) {
                console.error("Firebase Auth Error", e);
                document.getElementById('user-name').innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
            }
        }

        function setupAdminUI() {
            const adminBadge = document.getElementById('admin-badge');
            if (user.id === MY_ADMIN_ID) {
                adminBadge.classList.remove('hidden');
                adminBadge.onclick = toggleAdminMode;
            }
        }

        function toggleAdminMode() {
            isAdminView = !isAdminView;
            const badge = document.getElementById('admin-badge');
            badge.innerText = isAdminView ? "ADMIN" : "PRO";
            badge.classList.toggle('bg-red-500', isAdminView);
            badge.classList.toggle('text-white', isAdminView);
            
            if (isAdminView) {
                listenAllTasks();
            } else {
                if (unsubscribeAdminTasks) unsubscribeAdminTasks();
                render(tasks);
            }
            tg.HapticFeedback.impactOccurred('medium');
        }

        function initData() {
            const q = collection(db, 'artifacts', appId, 'users', String(user.id), 'tasks');
            unsubscribeUserTasks = onSnapshot(q, (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!isAdminView) render(tasks);
            }, (error) => {
                console.error("Firestore Listen Error:", error);
            });
        }

        function listenAllTasks() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'all_tasks');
            unsubscribeAdminTasks = onSnapshot(q, (snapshot) => {
                allUsersTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (isAdminView) render(allUsersTasks, true);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è "—É–º–Ω–æ–≥–æ" —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 1 —á–∞—Å, –µ—Å–ª–∏ –Ω–µ —Å–¥–µ–ª–∞–Ω–æ)
        function scheduleSmartReminder(taskText, ownerId) {
            // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω—É–∂–µ–Ω –±—ç–∫–µ–Ω–¥, 
            // –Ω–æ –º—ã –º–æ–∂–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ "–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å" –ª–æ–≥–∏–∫—É
            fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: ownerId,
                    text: `‚è≥ –ó–∞–¥–∞—á–∞ "${taskText}" –¥–æ–±–∞–≤–ª–µ–Ω–∞. –Ø –Ω–∞–ø–æ–º–Ω—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!`,
                    parse_mode: 'Markdown'
                })
            });
        }

        window.addTask = async () => {
            const input = document.getElementById('task-input');
            const timeInput = document.getElementById('task-time');
            const priorityInput = document.getElementById('task-priority');

            if (!input.value.trim()) {
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            const taskData = {
                text: input.value,
                time: timeInput.value,
                priority: priorityInput.value,
                done: false,
                userName: user.first_name,
                ownerId: user.id,
                createdAt: Date.now()
            };

            try {
                const userRef = collection(db, 'artifacts', appId, 'users', String(user.id), 'tasks');
                await addDoc(userRef, taskData);
                
                const publicRef = collection(db, 'artifacts', appId, 'public', 'data', 'all_tasks');
                await addDoc(publicRef, taskData);

                scheduleSmartReminder(taskData.text, user.id);

                input.value = '';
                timeInput.value = '';
                tg.HapticFeedback.impactOccurred('medium');
            } catch (e) {
                console.error("Add Task Error:", e);
                tg.showPopup({ message: "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –æ–±–ª–∞–∫–æ" });
            }
        };

        window.toggleTask = async (id, currentStatus) => {
            if (isAdminView) return; 
            const docRef = doc(db, 'artifacts', appId, 'users', String(user.id), 'tasks', id);
            await updateDoc(docRef, { done: !currentStatus });
            tg.HapticFeedback.selectionChanged();
        };

        window.deleteTask = async (id) => {
            if (isAdminView) return;
            const docRef = doc(db, 'artifacts', appId, 'users', String(user.id), 'tasks', id);
            await deleteDoc(docRef);
            tg.HapticFeedback.impactOccurred('light');
        };

        function render(dataList, isGlobal = false) {
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            
            const doneCount = dataList.filter(t => t.done).length;
            const progress = dataList.length > 0 ? (doneCount / dataList.length) * 100 : 0;
            
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-text').innerText = `${doneCount} / ${dataList.length}`;
            document.getElementById('user-name').innerText = isGlobal ? "–ì–ª–æ–±–∞–ª—å–Ω–∞—è –ª–µ–Ω—Ç–∞" : user.first_name;

            dataList.sort((a,b) => b.createdAt - a.createdAt).forEach(t => {
                const div = document.createElement('div');
                div.className = 'bg-white rounded-2xl p-4 flex items-center gap-4 mb-3 shadow-sm border border-slate-100 transition-all active:scale-[0.98]';
                div.innerHTML = `
                    <div onclick="toggleTask('${t.id}', ${t.done})" class="w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all ${t.done ? 'bg-slate-900 border-slate-900' : 'border-slate-300'}">
                        ${t.done ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                    </div>
                    <div class="flex-grow overflow-hidden" onclick="toggleTask('${t.id}', ${t.done})">
                        <p class="text-sm font-semibold truncate ${t.done ? 'line-through text-slate-400' : 'text-slate-800'}">${t.text}</p>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-[10px] font-bold px-1.5 py-0.5 rounded-md ${isGlobal ? 'bg-blue-50 text-blue-600' : 'bg-slate-100 text-slate-500'}">
                                ${isGlobal ? 'üë§ ' + t.userName : t.priority}
                            </span>
                            ${t.time ? `<span class="text-[10px] text-slate-400 font-medium flex items-center gap-0.5">üïí ${t.time}</span>` : ''}
                        </div>
                    </div>
                    ${!isGlobal ? `
                        <button onclick="deleteTask('${t.id}')" class="text-slate-300 hover:text-red-500 transition-colors p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    ` : ''}
                `;
                list.appendChild(div);
            });
        }

        startApp();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --tg-bg: var(--tg-theme-bg-color, #f8fafc);
            --tg-text: var(--tg-theme-text-color, #1e293b);
        }

        body { 
            background-color: var(--tg-bg); 
            color: var(--tg-text); 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            letter-spacing: -0.01em;
            user-select: none;
            overflow-x: hidden;
        }

        .custom-shadow { box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05); }

        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: opacity(0.4);
            cursor: pointer;
        }
    </style>
</head>
<body class="p-5 pb-24">
    <!-- Header -->
    <header class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-slate-900 rounded-2xl flex items-center justify-center text-white shadow-xl">
                <span class="text-xs font-black tracking-tighter italic">P21</span>
            </div>
            <div>
                <h1 class="text-xl font-extrabold text-slate-900 tracking-tight leading-none">PLANNER 21</h1>
                <p id="user-name" class="text-[10px] text-blue-600 font-bold uppercase mt-1.5 tracking-widest">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
            </div>
        </div>
        <div id="admin-badge" class="hidden px-4 py-2 bg-white shadow-sm border border-slate-100 text-slate-900 rounded-full text-[10px] font-black uppercase tracking-widest active:scale-90 transition-transform cursor-pointer">
            Pro
        </div>
    </header>

    <!-- Progress -->
    <div class="bg-white rounded-3xl p-5 mb-8 custom-shadow border border-slate-50">
        <div class="flex justify-between items-end mb-3">
            <span class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
            <span id="progress-text" class="text-sm font-black text-slate-800">0 / 0</span>
        </div>
        <div class="w-full h-2.5 bg-slate-100 rounded-full overflow-hidden">
            <div id="progress-bar" class="h-full bg-slate-900 transition-all duration-700 rounded-full" style="width: 0%"></div>
        </div>
    </div>

    <!-- Input Box -->
    <div class="bg-white p-3 rounded-3xl custom-shadow border border-slate-50 mb-8">
        <div class="flex items-center gap-2 mb-3">
            <input type="text" id="task-input" placeholder="–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å..." class="bg-slate-50 flex-grow px-5 py-3.5 rounded-2xl outline-none font-semibold text-sm text-slate-800">
            <button onclick="addTask()" class="bg-slate-900 text-white p-4 rounded-2xl shadow-lg active:scale-90 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
            </button>
        </div>
        <div class="flex gap-3">
            <div class="flex-1 bg-slate-50 px-4 py-3 rounded-2xl flex items-center gap-2">
                <input type="time" id="task-time" class="bg-transparent text-xs font-bold outline-none w-full text-slate-600">
            </div>
            <div class="flex-1 bg-slate-50 px-4 py-3 rounded-2xl flex items-center gap-2">
                <select id="task-priority" class="bg-transparent text-xs font-bold outline-none w-full text-slate-600 appearance-none">
                    <option value="–í—ã—Å–æ–∫–∏–π">üöÄ –í—ã—Å–æ–∫–∏–π</option>
                    <option value="–û–±—ã—á–Ω—ã–π" selected>‚ö°Ô∏è –û–±—ã—á–Ω—ã–π</option>
                    <option value="–ù–∏–∑–∫–∏–π">‚òÅÔ∏è –ù–∏–∑–∫–∏–π</option>
                </select>
            </div>
        </div>
    </div>

    <div id="task-list" class="space-y-1"></div>

</body>
</html>
